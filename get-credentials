#!/usr/bin/env python3

# By Michael Ludvig <mludvig@logix.net.nz> (c) 2017
# Webpage: https://aws.nz/aws-utils/get-credentials
# License: GPLv3

# Simple script that retrieves AWS credentials (access key,
# secret key and possibly security token) from any avaiable
# source:
# - Environment variables
# - ~/.aws/config or ~/.aws/credentials (including cross-account)
# - EC2 IAM Role
# - ...
# See http://boto3.readthedocs.io/en/latest/guide/configuration.html

import os
import sys
import argparse
import boto3

# Boto3 1.4.x or newer required
(ver_major, ver_minor, ver_patch) = boto3.__version__.split('.')
if int(ver_major)*100 + int(ver_minor) < 104:
    sys.exit("ERROR: Boto3 1.4.x or newer is required")

parser = argparse.ArgumentParser(formatter_class=argparse.RawDescriptionHelpFormatter)
parser.add_argument('--profile', dest='profile', type=str, help='Configuration profile from ~/.aws/{credentials,config}')
parser.add_argument('--region', dest='region', type=str, help='Set / override AWS region.')
parser.usage = "{} [options] [-- COMMAND [ARG ...]]".format(parser.prog)
parser.description='Retrieve AWS credentials from any available source'
parser.epilog='''
Examples:

1) Print AWS credentials from EC2 IAM Role

    ~ $ {prog}
    export AWS_ACCESS_KEY_ID=ASIAZXCVBNMASDFGHJKL
    export AWS_SECRET_ACCESS_KEY=lLvl4lTFLRERTuHi5Mrf4uuJ++8T7MlLvl4lT
    export AWS_SESSION_TOKEN=OnlOwq5fxy[...]2qJ1ZgqDDxp68romfqJh1x3yVy
    export _GET_CREDENTIALS_METHOD_USED=iam-role

2) Run a program with the AWS credentials environment variables set

    ~ $ {prog} --profile cross-account -- aws sts get-caller-identity
    {{
        "Account": "123456789012",
        "UserId": "AROAQWERTYUIOP1234556:AWS-CLI-session",
        "Arn": "arn:aws:sts::123456789012:assumed-role/CrossRole/AWS-CLI-session"
    }}

This is equivalent to 'aws --profile cross-account sts get-caller-identity'
and is intended for programs that do not support obtaining credentials
from ~/.aws/credentials or from EC2 instance IAM Role.


Visit https://aws.nz/aws-utils/get-credentials for more info
and more usage examples.
'''.format(prog=parser.prog)
args, cmd = parser.parse_known_args()

# Create command if we've got some "unknown_args" left
if cmd and cmd[0] == '--':
    cmd.pop(0)


env = {}
if args.profile:
    env['AWS_PROFILE']=args.profile

session = boto3.session.Session(profile_name=args.profile, region_name=args.region)
if session.region_name:
    env['AWS_DEFAULT_REGION']=session.region_name

credentials = session.get_credentials()
if not credentials:
    sys.exit("ERROR: Unable to locate credentials from any source.")

env['AWS_ACCESS_KEY_ID']=credentials.access_key
env['AWS_SECRET_ACCESS_KEY']=credentials.secret_key
if credentials.token:
    env['AWS_SESSION_TOKEN']=credentials.token

env['_GET_CREDENTIALS_METHOD_USED']=credentials.method

if cmd:
    import subprocess
    os.environ.update(env)
    cmd_run = subprocess.run(' '.join(cmd), shell=True)
    sys.exit(cmd_run.returncode)

for var in env.keys():
    print('export {}="{}"'.format(var, env[var]))

